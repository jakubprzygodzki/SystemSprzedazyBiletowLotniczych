<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8">
  <!--     <link rel = "stylesheet" type = "text/css"
         href = "https://cdnjs.cloudflare.com/ajax/libs/extjs/6.0.0/classic/theme-gray/resources/theme-gray-all.css" / >
      <script type = "text/javascript"
         src = "https://cdnjs.cloudflare.com/ajax/libs/extjs/6.0.0/ext-all.js"> </script>
      <script type = "text/javascript" src = "app.js" > </script>    -->
  <!--    <link rel = "stylesheet" type = "text/css"
         href = "ext-6.6.0/build/classic/theme-classic/resources/theme-classic-all.css" />
      <script type = "text/javascript" src = "ext-6.6.0/build/ext-all.js" > </script>   -->
  <link rel="stylesheet" type="text/css" href="extjs-master/build/classic/theme-classic/resources/theme-classic-all.css" />
  <script type="text/javascript" src="extjs-master/build/ext-all.js"> </script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
  <title>Bilety lotnicze</title>
  <link rel="stylesheet" href="css/main.css" />
  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
</head>

<body>
  <div id="intro">
    <img class="logoWAT" alt="WATLOGO" src="img/watLogo.jpg">
    <h1 id="app_title">BILETY LOTNICZE</h1>
    <h1>-WAT AIRLINES-</h1>
    <button id="language">Przełącz na angielski</button>
    <form action="http://localhost:8080/BiletyLotnicze/wyloguj" method="get">
      <input id="logoff" type="submit" value="Wyloguj">
    </form>
  </div>

  <article>
    <div id="darkLayer" class="darkClass" style="display:none"></div>
    <div id="main-form">
      <div class="inputField">
        <input id="inputFromCity" type="text" name="fromCity" placeholder=" Tu wpisz miasto startowe">
      </div>
      <div class="inputField">
        <input id="inputToCity" type="text" name="toCity" placeholder=" Tu wpisz miasto docelowe">
      </div>
      <div class="inputField">
        <input type="date" name="date">
      </div>
      <div id="buttons">
        <button id="submit" type="submit">Szukaj</button>
        <button id="deleteConnectionsItems">Cancel</button>
      </div>
    </div>

  </article>
  <form action="http://localhost:8080/BiletyLotnicze//dowloadTicket" method='POST' id='formid'>
    <input type='hidden' value='' name='name' id='name' />
    <input type='hidden' value=' ' name='lastName' id='lastName' />
    <input type='hidden' value=' ' name='pesel' id='pesel' />
    <input type='hidden' value=' ' name='arrivalTime' id='arrivalTime' />
    <input type='hidden' value=' ' name='departureTime' id='departureTime' />
    <input type='hidden' value=' ' name='arrivalPlace' id='arrivalPlace' />
    <input type='hidden' value=' ' name='departurePlace' id='departurePlace' />
    <input type='hidden' value=' ' name='seatNumber' id='seatNumber' />
    <input type='hidden' value=' ' name='date' id='date' />
    <input type='hidden' value=' ' name='idLotu' id='idLotu' />
    <input type='hidden' value=' ' name='lang' id='lang' />
  </form>

  <h3 id="location"> Lokalizacja docelowa: </h3>
  <div id="mapa1"></div>
  <div id="added-articles" class="table">
  </div>


  <script src="js/texts.js"></script>

  <script>
    //------------------------------------------------------------------------------
    function getString(sKey, sLang) {
      //------------------------------------------------------------------------------
      for (var key in aLanguageProperties) {
        if (key == sKey) {

          if (sLang === "PL") {
            return aLanguageProperties[key].PL;
          }
          if (sLang === "EN") {
            return aLanguageProperties[key].EN;
          }
        }
      }
    }

    //------------------------------------------------------------------------------
    function setLang(bChanged) {
      //------------------------------------------------------------------------------
      if (bChanged) {
        if (CURRENT_LANG.lang == "PL") {
          CURRENT_LANG.lang = "EN";
        } else if (CURRENT_LANG.lang == "EN") {
          CURRENT_LANG.lang = "PL";
        }
      }

      Ext.util.Cookies.set('jezyk', CURRENT_LANG.lang);

      var sLang = CURRENT_LANG.lang;

      var aTitle = document.getElementById("app_title");
      if (aTitle) {
        aTitle.innerHTML = getString("app_title", sLang);
      }

      var aRegistration = document.getElementById("registartion");
      if (aRegistration) {
        aRegistration.innerHTML = getString("registartion", sLang);
      }
      var aLanguage = document.getElementById("language");
      if (aLanguage) {
        aLanguage.innerHTML = getString("language", sLang);
      }


      var aLogin = document.getElementById("login");
      if (aLogin) {
        aLogin.value = getString("login", sLang);
      }


      var aInputFromCity = document.getElementById("inputFromCity");
      if (aInputFromCity) {
        aInputFromCity.placeholder = getString("inputFromCity", sLang);
      }


      var aInputToCity = document.getElementById("inputToCity");
      if (aInputToCity) {
        aInputToCity.placeholder = getString("inputToCity", sLang);
      }


      var aSearchBtn = document.getElementById("submit");
      if (aSearchBtn) {
        aSearchBtn.innerHTML = getString("button_Search", sLang);

      }

      var aCancel = document.getElementById("cancel1");
      if (aCancel) {
        aCancel.innerHTML = getString("button_Cancel", sLang);
      }

      var aPopupTologin = document.getElementById("popupTologin");
      if (aPopupTologin) {
        aPopupTologin.title = getString("popupTologin", sLang);
      }

      var aLogOff = document.getElementById("logoff");
      if (aLogOff) {
        aLogOff.value = getString("logoff", sLang);
      }

      var aLocation = document.getElementById("location");
      if (aLocation) {
        aLocation.innerHTML = getString("location", sLang);
      }
      return;
    }




    (function() {
      var aCookieLang = Ext.util.Cookies.get('jezyk');
      CURRENT_LANG.lang = aCookieLang;
      setLang(false);
    })();

    var aLanguage = document.getElementById("language");
    aLanguage.addEventListener("click", function() {
      setLang(true);
    }, true);



    // var aLanguage = document.getElementById("language");
    // aLanguage.addEventListener("click", check, true);

    //------------------------------------------------------------------------------
    showMessageBox = function(sText) {
      //------------------------------------------------------------------------------
      Ext.Msg.alert(getString("Warning", CURRENT_LANG.lang), sText, null);
    }


    //------------------------------------------------------------------------------
    showBuyTicketForm = function(aTicketData, aWindow1) {
      //------------------------------------------------------------------------------

      aWindow1.hide();

      var div = document.createElement("div");
      var h3 = document.createElement("h3");
      var h3Arrival = document.createElement("h3");
      var h3Departure = document.createElement("h3");

      var h3ArrivalTime = document.createElement("h3");
      var h3DepartureTime = document.createElement("h3");
      var h3Date = document.createElement("h3");
      var h4Imie = document.createElement("h4");
      var h4Nazwisko = document.createElement("h4");
      var h4Pesel = document.createElement("h4");

      h3.innerHTML = getString("SeatNumber", CURRENT_LANG.lang) + "<u>" + aTicketData.seatNumber + "</u>" + "</br";
      h3Arrival.innerHTML = getString("Start", CURRENT_LANG.lang) + "<u>" + aTicketData.fromCity + "</u>";
      h3Departure.innerHTML = getString("Destination", CURRENT_LANG.lang) + "<u>" + aTicketData.toCity + "</u>" + "</u>";
      h3ArrivalTime.innerHTML = getString("StartHour", CURRENT_LANG.lang) + "<u>" + aTicketData.departure + "</u>";
      h3DepartureTime.innerHTML = getString("DestinationHour", CURRENT_LANG.lang) + "<u>" + aTicketData.arrival + "</u>";
      h3Date.innerHTML = getString("travelDate", CURRENT_LANG.lang) + "<u>" + aTicketData.date + "</u>";

      h4Imie.innerHTML = getString("name", CURRENT_LANG.lang) ;
      h4Nazwisko.innerHTML = getString("lastName", CURRENT_LANG.lang);
      h4Pesel.innerHTML = getString("pesel", CURRENT_LANG.lang);

      var input1 = document.createElement("input");
      var input2 = document.createElement("input");
      var input3 = document.createElement("input");

      input1.id = "inputName";
      input2.id = "inputLastName";
      input3.id = "inputPESEL";

      div.appendChild(h3Date);
      div.appendChild(h3ArrivalTime);
      div.appendChild(h3DepartureTime);
      div.appendChild(h3Arrival);
      div.appendChild(h3Departure);
      div.appendChild(h3);
      div.appendChild(h4Imie);
      div.appendChild(input1);
      div.appendChild(h4Nazwisko);
      div.appendChild(input2);
      div.appendChild(h4Pesel);
      div.appendChild(input3);


      sendTicketData = function() {

        var aTicket = new Object();

        aTicket.inputName = document.getElementById('inputName').value;
        aTicket.inputLastName = document.getElementById('inputLastName').value;
        aTicket.inputPESEL = document.getElementById('inputPESEL').value;
        document.getElementById('name').value = aTicket.inputName;
        document.getElementById('lastName').value = aTicket.inputLastName;
        document.getElementById('pesel').value = aTicket.inputPESEL;
        document.getElementById('arrivalTime').value = aTicketData.arrival;
        document.getElementById('departureTime').value = aTicketData.departure;
        document.getElementById('arrivalPlace').value = aTicketData.fromCity;
        document.getElementById('departurePlace').value = aTicketData.toCity;
        document.getElementById('seatNumber').value = aTicketData.seatNumber;
        document.getElementById('date').value = aTicketData.date;
        document.getElementById('idLotu').value = aTicketData.idLotu;
        document.getElementById('lang').value = CURRENT_LANG.lang;

        $('#formid').submit();
      }

      var aWindow2 = Ext.create('Ext.window.Window', {
        title: getString("formTicket", CURRENT_LANG.lang),
        height: 500,
        width: 500,
        layout: 'fit',
        html: div.innerHTML,
        buttons: [{
          text: getString("downloadTicket", CURRENT_LANG.lang),
          handler: sendTicketData
        }]
      });

      aWindow2.show();

      return;
    }


    //------------------------------------------------------------------------------
    deleteWindow = function(okno) {
      //------------------------------------------------------------------------------
      okno.parentNode.removeChild(okno);
      var t = document.getElementById("darkLayer");
      t.style.display = "none";
      return;
    }


    //------------------------------------------------------------------------------
    function pobierzMiejsca(aParams) {
      //------------------------------------------------------------------------------

      var aID = {
        nr: aParams.flightID
      };
      $.ajax({
        url: "http://localhost:8080/BiletyLotnicze//seats",
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(aID),
        contentType: 'application/json',
        mimeType: 'application/json',

        success: function(data) {

          var aWindow1;
          var divContainer = document.createElement("div");
          divContainer.style.display = "none";

          for (var i in data) {

            var div = document.createElement("div");
            div.className = "seat";
            div.minWidth = "100px";
            div.minHeight = "50px";
            div.background = " blue";
            div.innerHTML = "<i class=\"fas fa-chair\"></i></br>" + data[i].nr;;
            div.style.zIndex = "100";
            div.id = data[i].nr;
            divContainer.appendChild(div);

            if (data[i].available == "0") {
              div.classList.add("freeSeat");
            } else {
              div.classList.add("noAvailable");
            }

          }

          aWindow1 = Ext.create('Ext.window.Window', {
            title: getString("chooseSeat", CURRENT_LANG.lang),
            height: 600,
            width: 350,
            layout: 'fit',
            resizable: false,
            scrollable: true,
            html: divContainer.innerHTML,
          });

          aWindow1.show();

          for (var i = 0; i < aWindow1.body.el.dom.childNodes.length; i++) {

            aWindow1.body.el.dom.childNodes[i].addEventListener("click", function(e) {

              aParams.seatNumber = e.target.id;

              if (e.target.className.indexOf("noAvailable") != -1) {
                alert(getString("noAvailable", CURRENT_LANG.lang));
                return;
              }
              showBuyTicketForm(aParams, aWindow1);

            }, false);
          }
        },
        error: function(data, status, er) {
          alert("error: " + data + " status: " + status + " er:" + er);
        }
      });
    }


    //------------------------------------------------------------------------------
    showPlaneSchedule = function(aParams) {
      //------------------------------------------------------------------------------
      pobierzMiejsca(aParams);

      return;
    }



    //------------------------------------------------------------------------------
    searchConnections = function() {
      //------------------------------------------------------------------------------
      var aDelete = document.getElementsByClassName("connectionItem");

      if (aDelete.length != 0) {
        var len = aDelete.length;
        for (var i = 0; i < len; i++) {
          aDelete[0].parentNode.removeChild(aDelete[0]);
        }
      }

      var article = new Object();
      article.inputFromCity = $('#inputFromCity').val();
      article.inputToCity = $('#inputToCity').val();

      var dateControl = document.querySelector('input[type="date"]');
      article.date = dateControl.value;

      $.ajax({
        url: "http://localhost:8080/BiletyLotnicze//jsonservlet",
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(article),
        contentType: 'application/json',
        mimeType: 'application/json',

        success: function(data) {

          var aUruluList = [];
          var sArrayOfIDsOfFlights = [];

          if (data.length == 0) {
            showMessageBox(getString("No_connection_found", CURRENT_LANG.lang));
          }

          for (var i in data) {

            var div = document.createElement("div");
            div.id = data[i].IDLotu;
            div.style.width = "700px";
            div.style.height = "22px";
            div.style.textAlign = "center";
            div.style.margin = "auto";
            div.style.marginTop = "15px";
            div.className = "connectionItem";
            div.style.transition = "all 0.7s";
            div.innerHTML = getString("from", CURRENT_LANG.lang) + "<b>" + data[i].inputFromCity + "</b>" + " " + getString("to", CURRENT_LANG.lang) + " <b>" + data[i].inputToCity + "</b>" + " (" + data[i].departure + " - " + data[i].arrival +
              "), " + getString("flightNum", CURRENT_LANG.lang) + data[i].IDLotu;

            div.infoAttributes = {
              flightID: data[i].IDLotu,
              fromCity: data[i].inputFromCity,
              toCity: data[i].inputToCity,
              arrival: data[i].arrival,
              departure: data[i].departure,
              date: data[i].date,
              idLotu: data[i].IDLotu
            };

            document.getElementById("added-articles").appendChild(div);

            div.addEventListener("click", function(e) {
              showPlaneSchedule(e.target.infoAttributes);
            }, false);

            var uluru = {};
            var aUluru = data[i].uluru.split(";");
            uluru.lat = aUluru[1];
            uluru.lng = aUluru[0];

            aUruluList.push(uluru);

          }

          initMap(aUruluList);

        },
        error: function(data, status, er) {
          alert("error: " + data + " status: " + status + " er:" + er);
        }
      });
    }

    //------------------------------------------------------------------------------
    showMap = function() {
      //------------------------------------------------------------------------------
      document.getElementById('mapa1').style.display = "block";
      document.getElementById('location').style.display = "block";
    }

    //------------------------------------------------------------------------------
    initMap = function(aUruluList) {
      //------------------------------------------------------------------------------

      if (aUruluList == undefined) {
        var uluru = {
          lat: 52.135333,
          lng: 21.019154
        };
        var map = new google.maps.Map(document.getElementById('mapa1'), {
          zoom: 9,
          center: uluru
        });
        var marker = new google.maps.Marker({
          position: uluru,
          map: map
        });
      } else {

        var map = new google.maps.Map(document.getElementById('mapa1'), {
          zoom: 4,
          center: {
            lat: 53.00,
            lng: 21.00
          }
        });

        var marker = [];

        for (var i = 0; i < aUruluList.length; i++) {

          aUruluList[i].lat = Number(aUruluList[i].lat);
          aUruluList[i].lng = Number(aUruluList[i].lng);

          uluru = {};
          uluru.lat = aUruluList[i].lat;
          uluru.lng = aUruluList[i].lng;

          marker[i] = new google.maps.Marker({
            position: uluru,
            map: map
          });
        }
      }
    }


    //------------------------------------------------------------------------------
    function deleteConnections() {
      //------------------------------------------------------------------------------
      var aDelete = document.getElementsByClassName("connectionItem");
      var len = aDelete.length;
      if (aDelete.length != 0) {

        for (var i = 0; i < len; i++) {
          aDelete[0].parentNode.removeChild(aDelete[0]);
        }
      }
      initMap(undefined);

    }


    var deleteConnectionsItems = document.getElementById("deleteConnectionsItems");
    deleteConnectionsItems.addEventListener("click", deleteConnections, true);

    var submit = document.getElementById("submit")
    submit.addEventListener("click", searchConnections, true);
    submit.addEventListener("click", showMap, true);
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBecyC_LYfo2Uo1GDB-RwKpyrBU5MYYgVc&callback=initMap">
  </script>


</body>

</html>
