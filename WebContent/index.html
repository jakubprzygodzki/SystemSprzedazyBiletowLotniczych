<!DOCTYPE html>
<html lang="pl">

<head>

  <link rel="stylesheet" type="text/css" href="extjs-master/build/classic/theme-classic/resources/theme-classic-all.css" />
  <script type="text/javascript" src="extjs-master/build/ext-all.js"> </script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
  <meta charset="UTF-8">
  <title>Bilety lotnicze</title>
  <link rel="stylesheet" href="css/main.css" />
  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
</head>

<body>
  <div id="intro">
    <img class="logoWAT" alt="WATLOGO" src="img/watLogo.jpg">
    <h1 id="app_title">BILETY LOTNICZE</h1>
    <h1>-WAT AIRLINES- </h1>
    <button id="registartion"> Rejestracja</button>
    <button id="language">Przełącz na angielski</button>
    <form action="http://localhost:8080/BiletyLotnicze/zaloguj.html" method="get">
      <input id="login" type="submit" value="Zaloguj">
    </form>
  </div>

  <article>
    <div id="darkLayer" class="darkClass" style="display:none"></div>
    <div id="main-form">
      <div class="inputField">
        <input id="inputFromCity" type="text" name="fromCity" placeholder=" Tu wpisz miasto startowe">
      </div>
      <div class="inputField">
        <input id="inputToCity" type="text" name="toCity" placeholder=" Tu wpisz miasto docelowe">
      </div>
      <div class="inputField">
        <input type="date" name="date">
      </div>
      <div id="buttons">
        <button id="submit" type="submit">Szukaj</button>
        <button id="cancel1" type="submit">Cancel</button>
      </div>
    </div>
  </article>

  <div id="added-articles" class="table">

  </div>

  <script src="js/texts.js"></script>


  <script>
    //------------------------------------------------------------------------------
    function getString(sKey, sLang) {
      //------------------------------------------------------------------------------
      for (var key in aLanguageProperties) {
        if (key == sKey) {

          if (sLang === "PL") {
            return aLanguageProperties[key].PL;
          }
          if (sLang === "EN") {
            return aLanguageProperties[key].EN;
          }
        }
      }
    }

    //------------------------------------------------------------------------------
    function setLang(bChanged) {
      //------------------------------------------------------------------------------
      if (bChanged) {
        if (CURRENT_LANG.lang == "PL") {
          CURRENT_LANG.lang = "EN";
        } else if (CURRENT_LANG.lang == "EN") {
          CURRENT_LANG.lang = "PL";
        }
      }

      Ext.util.Cookies.set('jezyk', CURRENT_LANG.lang);

      var sLang = CURRENT_LANG.lang;

      var aTitle = document.getElementById("app_title");
      aTitle.innerHTML = getString("app_title", sLang);

      var aRegistration = document.getElementById("registartion");
      aRegistration.innerHTML = getString("registartion", sLang);

      var aLanguage = document.getElementById("language");
      aLanguage.innerHTML = getString("language", sLang);

      var aLogin = document.getElementById("login");
      aLogin.value = getString("login", sLang);

      var aInputFromCity = document.getElementById("inputFromCity");
      aInputFromCity.placeholder = getString("inputFromCity", sLang);

      var aInputToCity = document.getElementById("inputToCity");
      aInputToCity.placeholder = getString("inputToCity", sLang);

      var aSearchBtn = document.getElementById("submit");
      aSearchBtn.innerHTML = getString("button_Search", sLang);

      var aCancel = document.getElementById("cancel1");
      if (aCancel) {
        aCancel.innerHTML = getString("button_Cancel", sLang);
      }
      var aPopupTologin = document.getElementById("popupTologin");
      if (aPopupTologin) {
        aPopupTologin.title = getString("popupTologin", sLang);
      }
      return;
    }

    (function() {
      var aCookieLang = Ext.util.Cookies.get('jezyk');
      CURRENT_LANG.lang = aCookieLang;
      setLang(false);
    })();

    var aLanguage = document.getElementById("language");
    aLanguage.addEventListener("click", function() {
      setLang(true);
    }, true);


    //------------------------------------------------------------------------------
    deleteConnectionsItemsNoLogin = function() {
      //------------------------------------------------------------------------------
      var aDelete = document.getElementsByClassName("connectionItemNoLogin");
      var nLength = aDelete.length;
      if (aDelete.length != 0) {

        for (var i = 0; i < nLength; i++) {
          aDelete[0].parentNode.removeChild(aDelete[0]);
        }
      }
    }


    var aCancel = document.getElementById("cancel1")
    aCancel.addEventListener("click", deleteConnectionsItemsNoLogin, true);

    var aSubmit = document.getElementById("submit")
    aSubmit.addEventListener("click", sendAjax, true);


    //------------------------------------------------------------------------------
    function sendAjax() {
      //------------------------------------------------------------------------------
      var aDelete = document.getElementsByClassName("connectionItemNoLogin");
      if (aDelete.length != 0) {

        var nLength = aDelete.length;

        for (var i = 0; i < nLength; i++) {
          aDelete[0].parentNode.removeChild(aDelete[0]);
        }
      }

      var aParam = new Object();
      aParam.inputFromCity = $('#inputFromCity').val();
      aParam.inputToCity = $('#inputToCity').val();
      var dateControl = document.querySelector('input[type="date"]');
      aParam.date = dateControl.value;

      $.ajax({
        url: "http://localhost:8080/BiletyLotnicze//jsonservlet",
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(aParam),
        contentType: 'application/json',
        mimeType: 'application/json',

        success: function(data) {

          for (var i in data) {

            var div = document.createElement("div");
            div.id = "popupTologin"
            div.style.width = "700px";
            div.style.height = "22px";
            div.style.textAlign = "center";
            div.style.color = "blue";
            div.style.margin = "auto";
            div.style.marginTop = "15px";
            div.className = "connectionItemNoLogin";
            div.style.transition = "all 0.7s";
            div.title = getString("popupTologin", CURRENT_LANG.lang);
            div.innerHTML = getString("from", CURRENT_LANG.lang) + "<b>" +data[i].inputFromCity + "</b>" + " " + getString("to", CURRENT_LANG.lang) + " <b>" + data[i].inputToCity + "</b>" + " (" + data[i].departure + " - " + data[i].arrival + "), " + getString("flightNum", CURRENT_LANG.lang) + data[i].IDLotu;
            document.getElementById("added-articles").appendChild(div);

            div.addEventListener("click", function() {
              showMessageBox(getString("popupTologin", CURRENT_LANG.lang));
            }, true);

          }

          if (data.length == 0) {
            //showMessageBox("Nie znaleziono żadnych połączeń!");
            showMessageBox(getString("No_connection_found", CURRENT_LANG.lang));
          }

        },
        error: function(data, status, er) {
          alert("error: " + data + " status: " + status + " er:" + er);
        }
      });
    }


    //------------------------------------------------------------------------------
    function initMap() {
      //------------------------------------------------------------------------------
      var uluru = {
        lat: 62.225333,
        lng: 11.019154
      };
      var map = new google.maps.Map(document.getElementById('mapa'), {
        zoom: 9,
        center: uluru
      });
      var marker = new google.maps.Marker({
        position: uluru,
        map: map
      });
    }


    //------------------------------------------------------------------------------
    goTozaloguj = function() {
      //------------------------------------------------------------------------------
      window.location.href = 'http://localhost:8080/BiletyLotnicze/zaloguj.html';
    }


    //------------------------------------------------------------------------------
    register = function() {
      //------------------------------------------------------------------------------
      var f = new Ext.FormPanel({
        id: 'ExtForm',
        labelWidth: 100,
        url: 'http://localhost:8080/BiletyLotnicze/zaloguj.html',
        height: 200,
        width: 350,
        frame: true,

        defaults: {
          width: 100
        },
        //applyTo: 'dlg-login-center',
        region: 'center',
        items: [{
            xtype: 'textfield',
            minWidth: 275,
            fieldLabel: getString("label_login", CURRENT_LANG.lang),
            name: 'login',
            vtype: 'login',
            id: 'loginInput'
          },
          {
            xtype: 'textfield',
            minWidth: 275,
            inputType: 'email',
            fieldLabel: getString("label_email", CURRENT_LANG.lang),
            name: 'email',
            allowBlank: false,
            id: 'emailInput'
          },
          {
            xtype: 'textfield',
            minWidth: 275,
            inputType: 'password',
            fieldLabel: getString("label_password", CURRENT_LANG.lang),
            name: 'password',
            allowBlank: false,
            id: 'passwordInput'
          }
        ],
        buttons: [{
            text: getString("button_register", CURRENT_LANG.lang),
            minWidth: 75,
            handler: function() {
              var aRegisterParmas = new Object();
              var sLogin = Ext.getCmp('loginInput').getValue();
              var sEmail = Ext.getCmp('emailInput').getValue();
              var sPassword = Ext.getCmp('passwordInput').getValue();

              aRegisterParmas.login = sLogin;
              aRegisterParmas.email = sEmail;
              aRegisterParmas.password = sPassword;


              if (sLogin == "" || sEmail == "" || sPassword == "") {
                Ext.Msg.alert(getString("Warning", CURRENT_LANG.lang), getString("empty_value", CURRENT_LANG.lang), null);
                return;
              }

              $.ajax({
                url: "http://localhost:8080/BiletyLotnicze//register",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(aRegisterParmas),
                contentType: 'application/json',
                mimeType: 'application/json',

                success: function(data) {

                  Ext.Msg.alert(getString("Warning", CURRENT_LANG.lang), getString("user_already_exists", CURRENT_LANG.lang), null);

                  if (data.indexOf("istnieje") > -1) {

                  } else {
                    Ext.getCmp('loginDlg').hide();
                  }

                },
                error: function(data, status, er) {
                  alert("error: " + JSON.stringify(data) + " status: " + status + " er:" + er);
                }
              });
            }
          },
          {
            text: 'Cancel',
            minWidth: 75,
            handler: function() {
              loginDlg.close()
            }
          }
        ]
      });


      var loginDlg = new Ext.Window({
        id: 'loginDlg',
        height: 300,
        width: 320,
        closable: true,
        modal: true,
        title: 'Login',
        layout: 'border',
        resizable: false,
        scrollable: true,
        items: f
      });
      loginDlg.show();
    }


    //------------------------------------------------------------------------------
    showMessageBox = function(sText) {
      //------------------------------------------------------------------------------
      Ext.Msg.alert(getString("Warning", CURRENT_LANG.lang), sText, null);
    }


    var registration = document.getElementById("registartion");
    registration.addEventListener("click", register, true);


  </script>

</body>

</html>
